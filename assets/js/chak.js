const ChakApp=(()=>{const e=["투구","무기","방패","의상","망토","신발","목걸이","반지","반지","보조","보조"],t=Array.from({length:12},((e,t)=>`+${9+t}`)),s=["피해저항관통","보스몬스터추가피해","치명위력%"],a=["피해저항관통","피해저항","대인방어","대인피해","상태이상저항","상태이상적중","대인방어%","대인피해%"];let n="투구",l="+9",o={},c=!0,r=1e4,i=1e4,d=1e4,u=1e4,p={},m={},v=[],g=[],f=null;const h=document.getElementById("equipment-selector"),y=document.getElementById("level-selector"),b=document.getElementById("stats-display");function E(e){return e.replace(/\d+$/,"")}function $(e){return e.startsWith("반지")?"반지":e}function k(){r=parseInt(document.getElementById("gold-button").value)||0,i=parseInt(document.getElementById("color-ball").value)||0,d=r,u=i,x()}function L(){const e=document.getElementById("gold-button"),t=document.getElementById("color-ball");e&&(e.value=r),t&&(t.value=i)}function x(){const e=document.getElementById("resource-summary");if(!e)return;const t=O(),s=u<0?"resource-negative":"resource-value";let a=`\n          <div class="resource-summary-item">\n              <img src="assets/img/gold-button.jpg" alt="황금단추" class="resource-icon-img">\n              <span class="resource-details">\n                  <span class="${d<0?"resource-negative":"resource-value"}">${d}</span> 보유\n                  / <span class="resource-value">${t.goldButtons}</span> 소모\n              </span>\n          </div>\n          <div class="resource-summary-item">\n              <img src="assets/img/fivecolored-beads.jpg" alt="오색구슬" class="resource-icon-img">\n              <span class="resource-details">\n                  <span class="${s}">${u}</span> 보유\n                  / <span class="resource-value">${t.colorBalls}</span> 소모\n              </span>\n          </div>\n      `;(d<0||u<0)&&(a+='<div class="resource-needed">',d<0&&(a+=`<div class="needed-item">\n                  <img src="assets/img/gold-button.jpg" alt="황금단추" class="resource-icon-img">\n                  <span class="resource-negative">${Math.abs(d)}</span> 추가 필요\n              </div>`),u<0&&(a+=`<div class="needed-item">\n                  <img src="assets/img/fivecolored-beads.jpg" alt="오색구슬" class="resource-icon-img">\n                  <span class="resource-negative">${Math.abs(u)}</span> 추가 필요\n              </div>`),a+="</div>"),e.innerHTML=a}function C(e,t,s){Array.from(e.children).forEach((e=>{"equip-btn"===s?e.classList.remove("bg-sky-500","text-white","font-bold"):"level-btn"===s&&e.classList.remove("bg-emerald-500","text-white","font-bold")})),"equip-btn"===s?t.classList.add("bg-sky-500","text-white","font-bold"):"level-btn"===s&&t.classList.add("bg-emerald-500","text-white","font-bold"),N(),I()}function S(e,t){const s=document.getElementById(t);if(!s)return;const a=new Set;e.forEach((([e,t],o)=>{const c=`${e}_${n}_${l}_${o}`;a.add(c);let r=document.querySelector(`[data-card-id="${c}"]`);r||(r=function(e,t,s,a,o){const c=m[a]||{level:0,value:0,isUnlocked:!1,isFirst:!1,part:n,partLevel:l,statName:e,maxValue:t};let r=c.level,i=c.value,v=c.isUnlocked,g=c.isFirst;const f=E(e),h=document.createElement("div");h.className="stat-card",h.dataset.statName=e,h.dataset.displayStatName=f,h.dataset.part=n,h.dataset.level=l,h.dataset.cardId=a,h.dataset.statIndex=o||0;const y=document.createElement("div");y.className="card-header",y.style.display="flex",y.style.justifyContent="space-between",y.style.alignItems="center";const b=document.createElement("h3");b.className="text-lg font-bold",b.textContent=f;const $=document.createElement("button");$.innerHTML="↻",$.className="redistribute-btn",$.title="능력치 재분배",$.addEventListener("click",(e=>{e.stopPropagation(),function(e,t){const s=parseInt(t.dataset.maxValue||"0"),a=(t.dataset.statName,t.dataset.part),n=t.dataset.level,l=`${a}_${n}`,o="true"===t.dataset.isUnlocked,c="true"===t.dataset.isFirst,r=parseInt(t.dataset.cardLevel||"0");c&&o?(p[l]=!1,r>=1&&(u+=500),r>=2&&(u+=500),r>=3&&(u+=500)):o&&(d+=500,r>=1&&(u+=400),r>=2&&(u+=500),r>=3&&(u+=500));delete m[e],t.dataset.cardLevel="0",t.dataset.value="0",t.dataset.isFirst="false",t.dataset.isUnlocked="false";const i=t.querySelector("p.value-display");i&&(i.textContent=`0 / ${s}`);const v=t.querySelector("p.progress-display");v&&(v.textContent="강화 단계: 0/3");let g=!1;document.querySelectorAll(`#stats-display > div[data-part="${a}"][data-level="${n}"]`).forEach((e=>{"true"===e.dataset.isUnlocked&&"true"===e.dataset.isFirst&&(g=!0)})),p[l]=g,document.querySelectorAll(`#stats-display > div[data-part="${a}"][data-level="${n}"]`).forEach((e=>{if("true"!==e.dataset.isUnlocked){const t=e.querySelector(".action-btn");t&&(t.innerHTML=g?'<img src="assets/img/gold-button.jpg" alt="황금단추" class="btn-icon"> <span>선택 500</span>':'<img src="assets/img/fivecolored-beads.jpg" alt="오색구슬" class="btn-icon"> <span>선택 500</span>')}}));const f=t.querySelector(".action-btn");f&&(f.innerHTML=g?'<img src="assets/img/gold-button.jpg" alt="황금단추" class="btn-icon"> <span>선택 500</span>':'<img src="assets/img/fivecolored-beads.jpg" alt="오색구슬" class="btn-icon"> <span>선택 500</span>',f.disabled=!1,f.classList.remove("disabled-btn"));L(),F(),I(),N(),x(),"block"===document.getElementById("search-results-modal").style.display&&_()}(a,h)})),y.appendChild(b),y.appendChild($);const k=document.createElement("p");k.className="value-display",k.textContent=`${i} / ${t}`;const C=document.createElement("div");C.className="progress-container";const S=document.createElement("div");S.className="progress-dots";for(let e=0;e<3;e++){const t=document.createElement("span");t.className="progress-dot gray",v&&(t.className=e<r?"progress-dot blue":"progress-dot yellow"),S.appendChild(t)}C.appendChild(S);const q=document.createElement("p");q.className="progress-display text-sm text-gray-600",q.textContent=`강화 단계: ${r}/3`,C.appendChild(q);const w=document.createElement("button");w.className="action-btn";const B=p[`${n}_${l}`]||!1;if(v)if(r<3){const e=g?500:0===r?400:500;w.innerHTML=`<img src="assets/img/fivecolored-beads.jpg" alt="오색구슬" class="btn-icon"> <span>강화 ${e}</span>`}else w.innerHTML="<span>완료</span>",w.disabled=!0,w.classList.add("disabled-btn");else w.innerHTML=B?'<img src="assets/img/gold-button.jpg" alt="황금단추" class="btn-icon"> <span>선택 500</span>':'<img src="assets/img/fivecolored-beads.jpg" alt="오색구슬" class="btn-icon"> <span>선택 500</span>';return w.addEventListener("click",(()=>{!function(e,t,s,a,n){let l=parseInt(e.dataset.cardLevel||"0"),o=parseInt(e.dataset.value||"0"),c="true"===e.dataset.isUnlocked,r="true"===e.dataset.isFirst;const i=e.querySelector("p.value-display"),m=e.querySelector("p.progress-display"),v=`${e.dataset.part}_${e.dataset.level}`;if(!c){let g=0;return p[v]?(g=500,r=!1):(g=0,r=!0),r?u-=500:d-=g,c=!0,p[v]?(o=Math.floor(a/15),t.innerHTML='<img src="assets/img/fivecolored-beads.jpg" alt="오색구슬" class="btn-icon"> <span>강화 400</span>',e.dataset.isFirst="false",e.dataset.isUnlocked="true"):(p[v]=!0,t.innerHTML='<img src="assets/img/fivecolored-beads.jpg" alt="오색구슬" class="btn-icon"> <span>강화 500</span>',e.dataset.isFirst="true",e.dataset.isUnlocked="true",Array.from(document.querySelectorAll("#stats-display > div")).forEach((t=>{if(t!==e&&t.dataset.part===e.dataset.part&&t.dataset.level===e.dataset.level&&"true"!==t.dataset.isUnlocked){const e=t.querySelector(".action-btn");e&&(e.innerHTML='<img src="assets/img/gold-button.jpg" alt="황금단추" class="btn-icon"> <span>선택 500</span>')}}))),e.dataset.cardLevel=l,e.dataset.value=o,i&&(i.textContent=`${o} / ${a}`),m&&(m.textContent=`강화 단계: ${l}/3`),D(n,l,o,c,r,e.dataset.part,e.dataset.level,s,a),F(),I(),N(),void x()}if(l<3){let d=0;if(d=r?500:0===l?400:500,u-=d,l++,r)o=Math.floor(a/3*l);else if(1===l){const e=Math.floor(a/15);o=e+(Math.floor(a/3)-e)}else o+=Math.floor(a/3),o>a&&(o=a);if(e.dataset.cardLevel=l,e.dataset.value=o,i&&(i.textContent=`${o} / ${a}`),m&&(m.textContent=`강화 단계: ${l}/3`),l<3){const e=500;t.innerHTML=`<img src="assets/img/fivecolored-beads.jpg" alt="오색구슬" class="btn-icon"> <span>강화 ${e}</span>`}else t.innerHTML="<span>완료</span>",t.disabled=!0,t.classList.add("disabled-btn");D(n,l,o,c,r,e.dataset.part,e.dataset.level,s,a),F(),I(),N(),x(),"block"===document.getElementById("search-results-modal").style.display&&_()}}(h,w,e,t,a)})),h.dataset.statName=e,h.dataset.maxValue=t,h.dataset.cardLevel=r,h.dataset.value=i,h.dataset.isFirst=g?"true":"false",h.dataset.isUnlocked=v?"true":"false",h.appendChild(y),h.appendChild(k),h.appendChild(C),h.appendChild(w),s.appendChild(h),h}(e,t,s,c,o)),r.style.display="flex"})),Array.from(s.children).forEach((e=>{a.has(e.dataset.cardId)||(e.style.display="none")})),function(){const e=p[`${n}_${l}`]||!1;Array.from(document.querySelectorAll("#stats-display > div")).filter((e=>"none"!==e.style.display)).forEach((t=>{if("true"!==t.dataset.isUnlocked){const s=t.querySelector(".action-btn");s&&(s.innerHTML=e?'<img src="assets/img/gold-button.jpg" alt="황금단추" class="btn-icon"> <span>선택 500</span>':'<img src="assets/img/fivecolored-beads.jpg" alt="오색구슬" class="btn-icon"> <span>선택 500</span>')}else{const e=t.querySelector(".action-btn");if(e){const s=parseInt(t.dataset.cardLevel||"0");if(s<3){const a="true"===t.dataset.isFirst?500:0===s?400:500;e.innerHTML=`<img src="assets/img/fivecolored-beads.jpg" alt="오색구슬" class="btn-icon"> <span>강화 ${a}</span>`}else e.innerHTML="<span>완료</span>",e.disabled=!0,e.classList.add("disabled-btn")}}}))}(),I(),N()}function I(){document.querySelectorAll(".stat-card").forEach((e=>{const t="true"===e.dataset.isUnlocked,s=parseInt(e.dataset.cardLevel||"0"),a=e.querySelectorAll(".progress-dot");a.length>0&&a.forEach(((e,a)=>{e.className="progress-dot gray",t&&(e.className=a<s?"progress-dot blue":"progress-dot yellow")}))}))}function N(){n&&e.forEach((e=>{e===n&&t.forEach((t=>{const s=function(e,t){const s=[],a=$(e),n=`lv${t.replace("+","")}`;o[a]&&o[a][n]&&Object.entries(o[a][n]).forEach((([a,n],l)=>{const o=`${a}_${e}_${t}_${l}`,c=E(a),r=m[o]||{level:0,value:0,isUnlocked:!1,isFirst:!1,part:e,partLevel:t,statName:a,maxValue:n};s.push({name:c,originalName:a,maxValue:n,state:r,index:l})}));return s}(e,t);if(0===s.length)return;y.querySelectorAll(".level-btn").forEach((e=>{if(e.querySelector(".level-text").textContent===t){const t=e.querySelector(".progress-dots");if(t){t.innerHTML="";const e=Math.min(4,s.length);for(let a=0;a<e;a++){const e=document.createElement("span"),n=s[a].state;n.isUnlocked?3===n.level?e.className="progress-dot blue":e.className="progress-dot yellow":e.className="progress-dot gray",t.appendChild(e)}}!function(e,t){const s=e.querySelector(".level-progress-bar"),a=e.querySelector(".level-status");if(!s||!a)return;let n=0,l=3*t.length,o=0;t.forEach((e=>{e.state.isUnlocked&&(n+=e.state.level,o++)}));const c=l>0?Math.round(n/l*100):0;s.style.width=`${c}%`,0===c?(s.classList.remove("partial","complete"),s.classList.add("empty")):c<100?(s.classList.remove("empty","complete"),s.classList.add("partial")):(s.classList.remove("empty","partial"),s.classList.add("complete"));a.textContent=o>0?`${o}/${t.length} (${c}%)`:""}(e,s)}}))}))}))}function q(){if(!n||!l)return;const e=$(n),t=`lv${l.replace("+","")}`,s=o[e];if(!s||!s[t])return void document.querySelectorAll("#stats-display > div").forEach((e=>{e.style.display="none"}));S(Object.entries(s[t]),"stats-display"),c?c=!1:F(),N(),x()}function w(){const e=new Set;for(const t in o)for(const s in o[t])for(const a in o[t][s]){const t=E(a);e.add(t)}return Array.from(e).sort()}function B(){const e=document.getElementById("stat-options");e&&(e.innerHTML="",v.forEach((t=>{const s=document.createElement("div");s.className="stat-option",s.textContent=t,s.addEventListener("click",(function(e){e.stopPropagation(),function(e){const t=g.indexOf(e);-1===t?g.push(e):g.splice(t,1);j(),M(!1)}(t)})),e.appendChild(s)})))}function j(){const e=document.getElementById("selected-stats");e&&(e.innerHTML="",g.forEach((t=>{const s=document.createElement("div");s.className="stat-chip",s.innerHTML=`${t} <span class="remove-stat" onclick="ChakApp.removeSelectedStat('${t}')">×</span>`,e.appendChild(s)})))}function M(e){const t=document.getElementById("stat-options");t&&(t.style.display=e?"block":"none",e&&(t.scrollTop=0))}function A(){const e=document.getElementById("search-input"),t=e.value.trim().toLowerCase();if(t||0!==g.length){if(t){const s=v.filter((e=>e.toLowerCase().includes(t)));if(0===s.length)return void alert("일치하는 능력치가 없습니다.");s.forEach((e=>{g.includes(e)||g.push(e)})),j(),e.value=""}_(),M(!1)}else alert("검색어를 입력하거나 능력치를 선택해주세요.")}function _(){if(0===g.length)return void alert("검색할 능력치를 선택해주세요.");let s=[];const a={};g.forEach((n=>{a[n]=0;for(const l of e){const e=$(l);if(o[e])for(const c of t){const t=`lv${c.replace("+","")}`;if(!o[e][t])continue;const r=Object.entries(o[e][t]);for(const[e,t]of r){const o=E(e);if(o===n){const r=`${e}_${l}_${c}_0`,i=m[r]?.isUnlocked||!1,d=m[r]?.level||0;a[n]+=t,s.push({part:l,level:c,statName:o,maxValue:t,cardId:r,isUnlocked:i,currentLevel:d})}}}}}));const n=U(s);H("검색 결과",s,a,"search",n)}function T(s,a){let n=[];const l={};a.forEach((s=>{l[s]=0;for(const a of e){const e=$(a);if(o[e])for(const c of t){const t=`lv${c.replace("+","")}`;if(!o[e][t])continue;const r=Object.entries(o[e][t]);for(const[e,t]of r){const o=E(e);if(o===s){const r=`${e}_${a}_${c}_0`,i=m[r]?.isUnlocked||!1,d=m[r]?.level||0;l[s]+=t,n.push({part:a,level:c,statName:o,maxValue:t,cardId:r,isUnlocked:i,currentLevel:d})}}}}}));const c=function(e){return U(e)}(n),r=`\n          <div class="preset-summary">\n              <div class="preset-header">\n                  <h4>${s} 조합 추천 능력치</h4>\n                  <div class="preset-stats">\n                      ${a.map((e=>`<span class="priority-stat">${e} <strong>최대 +${l[e]}</strong></span>`)).join("")}\n                  </div>\n              </div>\n              <div class="preset-resources">\n                  <div class="resource-req-title">모든 능력치 최대 강화 시 필요 자원:</div>\n                  <div class="resource-req-items">\n                      <div class="resource-req-item">\n                          <img src="assets/img/gold-button.jpg" alt="황금단추" class="resource-icon-img-small">\n                          <span>${c.goldButtons}</span>\n                      </div>\n                      <div class="resource-req-item">\n                          <img src="assets/img/fivecolored-beads.jpg" alt="오색구슬" class="resource-icon-img-small">\n                          <span>${c.colorBalls}</span>\n                      </div>\n                  </div>\n              </div>\n          </div>\n      `;H(`${s} 능력치 조합`,n,l,"보스용"===s?"boss":"pvp",c,r)}function H(t,s,a,n,l=null,o=null){const c="search"===n?"search-results-modal":"optimize-results-modal",r=document.getElementById(c),i="search"===n?null:document.getElementById("optimize-title"),d="search"===n?null:document.getElementById("optimize-description"),u=document.getElementById("search"===n?"search-results":"optimize-results");if(!r||!u)return;i&&(i.textContent=t);let p="";if("boss"===n?p='\n              <div class="ad-row">\n                  <div class="ad-container-left">\n                      <ins class="kakao_ad_area" style="display:none;" data-ad-unit="DAN-UkkhjQ9GYeZ3sOXB"\n                          data-ad-width="728" data-ad-height="90"></ins>\n                  </div>\n              </div>\n              <div class="ad-container mobile-ad">\n                  <ins class="kakao_ad_area" style="display:none;" data-ad-unit="DAN-BhKdcNxF7CCOuMnG"\n                      data-ad-width="320" data-ad-height="50"></ins>\n              </div>\n          ':"pvp"===n?p='\n              <div class="ad-row">\n                  <div class="ad-container-left">\n                      <ins class="kakao_ad_area" style="display:none;" data-ad-unit="DAN-LtG5sjZScAmdPYfF"\n                          data-ad-width="728" data-ad-height="90"></ins>\n                  </div>\n              </div>\n              <div class="ad-container mobile-ad">\n                  <ins class="kakao_ad_area" style="display:none;" data-ad-unit="DAN-R6nzUmJFWnh04OdE"\n                      data-ad-width="320" data-ad-height="50"></ins>\n              </div>\n          ':"search"===n&&(p='\n              <div class="ad-row">\n                  <div class="ad-container-left">\n                      <ins class="kakao_ad_area" style="display:none;" data-ad-unit="DAN-dPt3jx9Ie5yTkVJy"\n                          data-ad-width="728" data-ad-height="90"></ins>\n                  </div>\n              </div>\n              <div class="ad-container mobile-ad">\n                  <ins class="kakao_ad_area" style="display:none;" data-ad-unit="DAN-Zbrtp5BDtY7qDIcS"\n                      data-ad-width="320" data-ad-height="50"></ins>\n              </div>\n          '),0===s.length)return u.innerHTML=p+'<div class="no-results">검색 결과가 없습니다.</div>',void(r.style.display="block");if(d&&o&&(d.innerHTML=o),"search"===n&&l){const e=document.getElementById("search-summary-stats"),t=document.getElementById("search-resource-requirement"),n=document.getElementById("searched-stats-list");if(e&&t&&n){e.innerHTML="",t.innerHTML="",n.innerHTML="";let o="";Object.entries(a).forEach((([e,t])=>{o+=`<span class="summary-stat-badge">${e} <strong>최대 +${t}</strong></span>`})),e.innerHTML=o,t.innerHTML=`\n                  <div class="resource-req-item">\n                      <img src="assets/img/gold-button.jpg" alt="황금단추" class="resource-icon-img-small">\n                      <span>${l.goldButtons}</span>\n                  </div>\n                  <div class="resource-req-item">\n                      <img src="assets/img/fivecolored-beads.jpg" alt="오색구슬" class="resource-icon-img-small">\n                      <span>${l.colorBalls}</span>\n                  </div>\n              `;let c="";Object.entries(a).forEach((([e,t])=>{s.filter((t=>t.statName===e)).length>0&&(c+=`\n                          <div class="searched-stat-item" onclick="ChakApp.highlightStatInResults('${e}')">\n                              <span class="searched-stat-name">${e}</span>\n                              <span class="searched-stat-value">+${t}</span>\n                          </div>`)})),n.innerHTML=c}}const m={};s.forEach((e=>{m[e.statName]||(m[e.statName]=[]),m[e.statName].push(e)})),u.innerHTML="";let v=p;v+='<div class="compact-results">';let g=0;for(const[t,s]of Object.entries(m)){g++;const l=`${n}-stat-group-${g}`,o=1===g;v+=`<div class="compact-group" data-stat="${t}">\n              <div class="compact-stat-title" data-target="${l}">\n                  <div class="stat-name-section">\n                      <span class="toggle-icon">${o?"▼":"►"}</span>\n                      ${t}\n                      <span class="stat-count">(${s.length}곳)</span>\n                  </div>\n                  <div class="stat-info">\n                      <span class="stat-total-value">최대 +${a[t]}</span>\n                  </div>\n              </div>\n              <div id="${l}" class="stat-group-content" ${o?"":'style="display:none;"'}>`;const c=Object.groupBy(s,(e=>e.part)),r=Object.keys(c).sort(((t,s)=>e.indexOf(t)-e.indexOf(s)));for(const e of r){const t=c[e];t.sort(((e,t)=>parseInt(e.level.replace("+",""))-parseInt(t.level.replace("+",""))));const s=t.reduce(((e,t)=>e+t.maxValue),0);v+=`<div class="part-section">\n                  <div class="part-header">\n                      <span>${e}</span>\n                      <span class="part-value">+${s} (${t.length}개)</span>\n                  </div>\n                  <div class="compact-locations">`,t.forEach((e=>{let t="location-unused";e.isUnlocked&&(t=3===e.currentLevel?"location-complete":"location-partial");const s="search"===n?`ChakApp.selectStatFromSearch('${e.part}', '${e.level}')`:`ChakApp.selectStatFromPreset('${e.part}', '${e.level}')`;v+=`\n                      <div class="compact-location ${t}" onclick="${s}">\n                          <div class="loc-header">\n                              <span class="loc-level">lv ${e.level}</span>\n                          </div>\n                          <div class="loc-details">\n                              <span class="loc-max-value">+${e.maxValue}</span>\n                          </div>\n                      </div>`})),v+="</div></div>"}v+="</div></div>"}v+="</div>",u.innerHTML=v;if(u.querySelectorAll(".compact-stat-title").forEach((e=>{e.addEventListener("click",(function(){const e=this.getAttribute("data-target"),t=document.getElementById(e),s=this.querySelector(".toggle-icon");"none"===t.style.display?(t.style.display="block",s.textContent="▼",t.style.maxHeight="0",setTimeout((()=>{t.style.maxHeight=t.scrollHeight+"px"}),10)):(s.textContent="►",t.style.maxHeight="0",setTimeout((()=>{t.style.display="none"}),300))}))})),"search"!==n){const e=document.querySelector(".apply-btn");e&&(e.textContent="창 닫기",e.onclick=z)}if(window.innerWidth<=768?(r.querySelectorAll(".mobile-ad .kakao_ad_area").forEach((e=>{e.style.display="block"})),r.querySelectorAll(".ad-container-left .kakao_ad_area").forEach((e=>{e.style.display="none"}))):(r.querySelectorAll(".ad-container-left .kakao_ad_area").forEach((e=>{e.style.display="block"})),r.querySelectorAll(".mobile-ad .kakao_ad_area").forEach((e=>{e.style.display="none"}))),window.adfit)window.adfit();else{const e=document.createElement("script");e.src="//t1.daumcdn.net/kas/static/ba.min.js",e.async=!0,document.body.appendChild(e)}r.style.display="block"}function U(e){const t={};let s=0,a=0;return e.forEach((e=>{const s=`${e.part}_${e.level}`;t[s]||(t[s]=[]),t[s].push(e)})),Object.values(t).forEach((e=>{let t=!1;e.forEach((e=>{e.isUnlocked&&(t=!0)})),!t&&e.length>0?(a+=500,e.length>1&&(s+=500*(e.length-1),a+=1400*(e.length-1))):e.forEach((e=>{const t=function(e){const t=e.isUnlocked?0:500;let s=0;e.isUnlocked?(e.currentLevel<1&&(s+=500),e.currentLevel<2&&(s+=500),e.currentLevel<3&&(s+=500)):s=500;return{goldButtons:t,colorBalls:s}}(e);s+=t.goldButtons,a+=t.colorBalls}))})),{goldButtons:s,colorBalls:a}}function O(){let e=0,t=0;const s={};return Object.entries(m).forEach((([e,t])=>{if(!t.isUnlocked)return;const a=`${t.part}_${t.partLevel}`;s[a]||(s[a]=[]),s[a].push(t)})),Object.entries(s).forEach((([s,a])=>{a.find((e=>e.isFirst));a.forEach((s=>{s.isFirst?(s.level>=1&&(t+=500),s.level>=2&&(t+=500),s.level>=3&&(t+=500)):(e+=500,s.level>=1&&(t+=400),s.level>=2&&(t+=500),s.level>=3&&(t+=500))}))})),{goldButtons:e,colorBalls:t}}function F(){const e={};let t=0;Object.entries(m).forEach((([s,a])=>{if(a.value>0){const s=E(a.statName);e[s]||(e[s]=0),e[s]+=a.value,t+=a.level}}));O();!function(e,t){const s=document.getElementById("summary-display");if(!s)return;let a="";const n=Object.entries(t).sort(((e,t)=>t[1]-e[1]));if(n.length>0){a+='<div class="stat-list">';for(const[e,t]of n)t>0&&(a+=`\n                      <div class="stat-item">\n                          <span class="stat-name">${e}</span> \n                          <span class="stat-value">+${t}</span>\n                      </div>`);a+="</div>"}else a="<p>능력치가 개방되지 않았습니다.</p>";s.innerHTML=`\n          <div class="summary-section">\n              ${a}\n          </div>\n      `}(0,e)}function D(e,t,s,a,n,l,o,c,r){m[e]={level:t,value:s,isUnlocked:a,isFirst:n,part:l,partLevel:o,statName:c,maxValue:r}}function V(){const s=document.getElementById("gold-button"),a=document.getElementById("color-ball");s&&(s.addEventListener("change",k),s.addEventListener("input",k),r=parseInt(s.value)||1e4,d=r),a&&(a.addEventListener("change",k),a.addEventListener("input",k),i=parseInt(a.value)||1e4,u=i);const o=document.getElementById("search-input");o&&(o.addEventListener("click",(function(e){e.stopPropagation(),M(!0)})),o.addEventListener("focus",(function(){M(!0)})),o.addEventListener("input",(function(){!function(e){const t=document.getElementById("stat-options"),s=t.querySelectorAll(".stat-option");e=e.toLowerCase();let a=0;s.forEach((t=>{const s=t.textContent.toLowerCase().includes(e);t.style.display=s?"flex":"none",s&&a++}));const n=t.querySelector(".no-matches");if(0===a){if(!n){const e=document.createElement("div");e.className="no-matches",e.textContent="일치하는 항목 없음",t.appendChild(e)}}else n&&n.remove();M(!0)}(this.value)})),o.addEventListener("keydown",(function(e){"Enter"===e.key&&(e.preventDefault(),A())}))),document.addEventListener("click",(function(e){const t=document.getElementById("stat-options"),s=document.getElementById("search-input");t&&s&&(s.contains(e.target)||t.contains(e.target)||M(!1))})),L(),x(),e.forEach((e=>{const t=document.createElement("button");t.className="selector-btn equip-btn",t.textContent=e,t.addEventListener("click",(()=>{n=e,C(h,t,"equip-btn"),q()})),h.appendChild(t),"투구"===e&&t.classList.add("bg-sky-500","text-white","font-bold")})),t.forEach((e=>{const t=document.createElement("button");t.className="selector-btn level-btn";const s=document.createElement("div");s.className="level-text",s.textContent=e,t.appendChild(s);const a=document.createElement("div");a.className="level-progress-container";const n=document.createElement("div");n.className="level-status",n.textContent="";const o=document.createElement("div");o.className="level-progress-bar empty",o.style.width="0%",a.appendChild(n),a.appendChild(o),t.appendChild(a);const c=document.createElement("div");c.className="progress-dots";for(let e=0;e<4;e++){const e=document.createElement("span");e.className="progress-dot gray",c.appendChild(e)}t.appendChild(c),t.addEventListener("click",(()=>{l=e,C(y,t,"level-btn"),q()})),y.appendChild(t),"+9"===e&&t.classList.add("bg-emerald-500","text-white","font-bold")}))}function P(){const e=document.getElementById("search-results-modal");e&&(e.style.display="none")}function z(){const e=document.getElementById("optimize-results-modal");e&&(e.style.display="none"),f=null}function R(e,t){const s=document.querySelectorAll(".equip-btn");let a=null;for(const t of s)if(t.textContent===e){a=t;break}a&&(n=e,C(h,a,"equip-btn"));const o=document.querySelectorAll(".level-btn");let c=null;for(const e of o){const s=e.querySelector(".level-text");if(s&&s.textContent===t){c=e;break}}c&&(l=t,C(y,c,"level-btn")),q(),P()}return{initUI:V,loadChakData:async function(){try{const e=await async function(e,t,s=24){const a=localStorage.getItem(e),n=localStorage.getItem(`${e}_time`),l=(new Date).getTime(),o=60*s*60*1e3;if(a&&n&&l-parseInt(n)<o)return JSON.parse(a);const c=await t();return localStorage.setItem(e,JSON.stringify(c)),localStorage.setItem(`${e}_time`,l.toString()),c}("chakData",(async()=>await async function(e){try{const t=window.CommonData.DOCUMENT_MAP[e];if(!t)throw new Error(`No mapping for ${e}`);const s=await db.collection("jsonData").doc(t).get();if(!s.exists)throw new Error(`Document ${t} not found`);const a=s.data();if(!a)throw new Error(`Document ${t} exists but has no data`);return a}catch(t){const s=await fetch(`output/${e}`);return await s.json()}}("chak.json")),24);o=e,v=w(),V(),B(),q(),x()}catch(e){console.error("Failed to load chak data:",e),b&&(b.innerHTML=`<p class="text-red-500">${e.message||"데이터를 불러오는 데 실패했습니다."}</p>`);try{const e=await fetch("output/chak.json"),t=await e.json();o=t,v=w(),V(),B(),q(),x()}catch(e){console.error("Local fallback also failed:",e),b&&(b.innerHTML='<p class="text-red-500">데이터를 불러오는 데 실패했습니다.</p>')}}},searchStats:A,removeSelectedStat:function(e){const t=g.indexOf(e);-1!==t&&g.splice(t,1),j()},highlightStatInResults:function(e){document.querySelectorAll(".compact-group").forEach((t=>{if(t.getAttribute("data-stat")===e){const e=t.querySelector(".compact-stat-title").getAttribute("data-target"),s=document.getElementById(e),a=t.querySelector(".toggle-icon");"none"===s.style.display&&(s.style.display="block",a.textContent="▼",s.style.maxHeight=s.scrollHeight+"px"),t.scrollIntoView({behavior:"smooth",block:"start"}),t.classList.add("highlight-group"),setTimeout((()=>{t.classList.remove("highlight-group")}),1500)}}))},selectStatFromSearch:R,selectStatFromPreset:function(e,t){R(e,t),z()},closeSearchResults:P,closeOptimizeResults:z,optimizeStats:function(e){let t=[],n="";if("boss"===e)t=s,n="보스용";else{if("pvp"!==e)return void alert("유효하지 않은 프리셋입니다.");t=a,n="PvP용"}T(n,t)}}})();firebase.initializeApp(firebaseConfig);const db=firebase.firestore();ChakApp.loadChakData();