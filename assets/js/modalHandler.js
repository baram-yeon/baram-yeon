const ModalHandler=function(){let e=null,t=[],n=0,l="",a="";function i(i,d,m){e=function(){let e=document.querySelector(".modal-overlay");if(e){const t={overlay:e,container:e.querySelector(".modal")};if(t.container)return t;e.remove(),e=null}e=document.createElement("div"),e.className="modal-overlay";const t=document.createElement("div");t.className="modal";const n=document.createElement("button");return n.className="modal-close",n.innerHTML="✕",n.setAttribute("aria-label","닫기"),n.onclick=u,t.appendChild(n),e.appendChild(t),document.body.appendChild(e),document.addEventListener("keydown",c),e.addEventListener("click",s),{overlay:e,container:t}}();const p=e.container,v=e.overlay;p.innerHTML="";const y=document.createElement("button");y.className="modal-close",y.innerHTML="✕",y.setAttribute("aria-label","닫기"),y.onclick=u,p.appendChild(y);const f=window.DataManager.getData(i);if(!f||!Array.isArray(f))return p.innerHTML+="<p>정보를 표시할 수 없습니다.</p>",v.style.display="flex",void(document.body.style.overflow="hidden");const h=f.find((e=>e&&e.image===d));if(!h)return p.innerHTML+="<p>선택한 환수 정보를 찾을 수 없습니다.</p>",v.style.display="flex",void(document.body.style.overflow="hidden");t=Array.isArray(h.stats)?h.stats:[],n=0,l=h.name||"이름 없음",a=m||h.influence||"";const E=function(e){const i=document.createElement("div");i.className="modal-header";const d=document.createElement("img");d.src=e,d.alt=l,d.className="modal-img-preview";const c=document.createElement("div");c.className="title-area";const s=document.createElement("h3");if(s.textContent=l+" ",a&&window.DataManager.FACTION_ICONS&&window.DataManager.FACTION_ICONS[a]){const e=document.createElement("img");e.src=window.DataManager.FACTION_ICONS[a],e.alt=`${a} 아이콘`,e.title=a,e.className="influence-icon",s.appendChild(e)}else if(a&&"정보없음"!==a){const e=document.createElement("span");e.textContent=`(${a})`,e.style.fontSize="0.8em",e.style.marginLeft="5px",s.appendChild(e)}const u=function(){const e=document.createElement("div");e.classList.add("level-controls");const l=document.createElement("button");l.innerText="-",l.setAttribute("aria-label","레벨 감소"),l.addEventListener("click",(()=>o(-1)));const a=document.createElement("input");a.type="number",a.min="0",a.max="25",a.value=n,a.classList.add("level-input"),a.setAttribute("aria-label","환수 레벨"),a.addEventListener("input",(function(){let e=parseInt(this.value,10);(isNaN(e)||e<0)&&(e=0),e>25&&(e=25),this.value=e,n=e;r(t.find((e=>e&&e.level===n))||null)})),a.addEventListener("keypress",(e=>{/\d/.test(e.key)||e.preventDefault()}));const i=document.createElement("button");i.innerText="+",i.setAttribute("aria-label","레벨 증가"),i.addEventListener("click",(()=>o(1)));const d=document.createElement("button");return d.innerText="MAX",d.classList.add("max-button"),d.setAttribute("aria-label","최대 레벨 설정"),d.addEventListener("click",(()=>{n=25,a.value=n;r(t.find((e=>e&&e.level===n))||null)})),e.appendChild(l),e.appendChild(a),e.appendChild(i),e.appendChild(d),e}();return c.appendChild(s),c.appendChild(u),i.appendChild(d),i.appendChild(c),i}(d),b=function(){const e=document.createElement("div");e.className="stats-container";const t=document.createElement("div");t.className="stats-column";const n=document.createElement("b");n.innerText="📌 등록 효과:";const l=document.createElement("ul");l.id="registrationList",t.appendChild(n),t.appendChild(l);const a=document.createElement("div");a.className="stats-column";const i=document.createElement("b");i.innerText="🧷 결속 효과:";const o=document.createElement("ul");return o.id="bindList",a.appendChild(i),a.appendChild(o),e.appendChild(t),e.appendChild(a),e}();p.appendChild(E),p.appendChild(b);r(t.find((e=>e&&e.level===n))||null),v.style.display="flex",document.body.style.overflow="hidden"}function o(e){const l=n+e;if(l<0||l>25)return;n=l;const a=document.querySelector(".level-input");a&&(a.value=n);r(t.find((e=>e&&e.level===n))||null)}function r(e){const l=document.getElementById("registrationList"),a=document.getElementById("bindList");if(!l||!a)return;l.innerHTML="",a.innerHTML="";const i=l.parentNode,o=a.parentNode;i?.querySelectorAll(".level25-notice").forEach((e=>e.remove())),o?.querySelectorAll(".level25-notice").forEach((e=>e.remove()));const r=t.find((e=>e&&25===e.level)),c=r?.registrationStat&&Object.keys(r.registrationStat).length>0,s=r?.bindStat&&Object.keys(r.bindStat).length>0;if(e?.registrationStat&&Object.keys(e.registrationStat).length>0)d(l,e.registrationStat);else if(25!==n&&c){l.innerHTML=`<li>현재 레벨(${n})에는 등록 효과가 없습니다.</li>`;const e=document.createElement("div");e.className="level25-notice",e.textContent="※ 등록 효과는 25레벨 달성 시 적용됩니다.",i?.appendChild(e)}else l.innerHTML=`<li>레벨 ${n}: 등록 효과 정보 없음</li>`;if(e?.bindStat&&Object.keys(e.bindStat).length>0)d(a,e.bindStat);else if(25!==n&&s){a.innerHTML=`<li>현재 레벨(${n})에는 결속 효과가 없습니다.</li>`;const e=document.createElement("div");e.className="level25-notice",e.textContent="※ 결속 효과는 25레벨 달성 시 적용됩니다.",o?.appendChild(e)}else a.innerHTML=`<li>레벨 ${n}: 결속 효과 정보 없음</li>`}function d(e,t){if(!t||"object"!=typeof t||0===Object.keys(t).length)return void(e.innerHTML="<li>정보 없음</li>");const n={};Object.entries(t).forEach((([e,t])=>{if(null==e||null==t)return;const l=window.DataManager.STATS_MAPPING[e]||e.toString(),a=t.toString();if(n[l]){const e=parseFloat(n[l].val),t=parseFloat(a);isNaN(e)||isNaN(t)||(n[l].val=(e+t).toString())}else n[l]={key:e,val:a,order:window.DataManager.STATS_ORDER.indexOf(e)}}));const l=Object.entries(n).sort((([,e],[,t])=>{const n=e.order,l=t.order;return-1!==n&&-1!==l?n-l:-1!==n?-1:-1!==l?1:e.key.localeCompare(t.key)}));e.innerHTML="",0!==l.length?l.forEach((([t,n])=>{const l=document.createElement("li"),a=n.val,i=window.DataManager.SPECIAL_STAT_CLASSES[t]||"";i?l.innerHTML=`<span class="${i}">${t}: ${a}</span>`:l.textContent=`${t}: ${a}`,e.appendChild(l)})):e.innerHTML="<li>표시할 능력치 없음</li>"}function c(t){"Escape"===t.key&&"flex"===e?.overlay.style.display&&u()}function s(t){t.target===e?.overlay&&"flex"===e?.overlay.style.display&&u()}function u(){e&&e.overlay&&(e.overlay.style.display="none",document.body.style.overflow="auto")}return{showInfo:function(e,t,n){i(e,t,n)},showInfoInModal:i,closeModal:u}}();window.ModalHandler=ModalHandler;